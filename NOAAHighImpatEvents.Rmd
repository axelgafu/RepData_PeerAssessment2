```{r, echo=FALSE, message=FALSE}
library(dplyr)
library(lubridate)
# https://s3.amazonaws.com/coursera-uploads/user-1107d4326e33ea6b7f5737ae/973515/asst-4/78865c4000ff11e58056abca0f13509f.pdf
# http://rpubs.com/cybernurl/Rep_PeerAssessment2
```
High Impact Whether Events in U.S. based on Storm Data
================================================================


## Synopsis

This document contains the anlysis done over the Storm Data generated by the U.S. 
National Oceanic and Atmospheric Administration's. The analysis is aimed to answer
the following questions: 

1. Across the United States, which types of events are most harmful with respect
to population health?

2. Across the United States, which types of events have the greatest economic 
consequences?

Those questions are answered in Conclusions section which within Results section
below. Data processing section discusses how that conclusion was inferred.


## Data Processing 
The data is being retrieved from a link provided in the cloudfront web site. The
data is downloaded only if it has not been downloaded yet:
```{r "Download Data"}

if( !file.exists( "data.bz2" ) )
{
    download.file("https://d396qusza40orc.cloudfront.net/repdata%2Fdata%2FStormData.csv.bz2", "data.bz2", method="curl")
}
```

The data is directly read from the bz2 file:
```{r "Process Data", cache=TRUE}
data <- read.csv( bzfile("data.bz2") )
```

Since the data should show what are the events that has caused the most injuries,
the data is organized by event and ordered to show the 10 events with the bigger
injuries registered.
```{r "Events Bigger Injuries", cache=TRUE}
injbyevt <- data %>% 
    group_by( EVTYPE ) %>% 
    summarize( Injuries=sum(INJURIES))

print( 
    injbyevt[order(injbyevt$Injuries, decreasing=TRUE), ], 
    type="html", 
    row.names=FALSE )
```

Percentage of injuries caused by documented Tornado events is:
```{r}
injbyevt$Injuries[injbyevt=="TORNADO"] / sum(injbyevt$Injuries) * 100
```

Another objective of this analysis is to know what events are the most expensive
ones. In order to do so, the data is grouped by Event Type and the sum of the
most expensive events is shown:
```{r "Process Data1", cache=TRUE}
propdmgevt <- data %>% 
    group_by( EVTYPE ) %>% 
    summarize( Property_Damage_Cost=sum(PROPDMG))

print( 
    propdmgevt[order(propdmgevt$Property_Damage_Cost, decreasing=TRUE), ], 
    type="html", 
    row.names=FALSE )
```


One characteristic that this that has is it has a lot of events that does not have
documented injuries or property costs:
```{r "Injuties and Property Costs = 0"}
# Percentage of records with Property_Damage_Cost = 0
mean(propdmgevt$Property_Damage_Cost == 0 ) * 100
# Percentage of records with Injuries = 0
mean(injbyevt$Injuries == 0 ) * 100
```

Given that situation and since what this analysis is trying to identify the most
representative incidences, those cases with 0 injuries and property damages will
be removed form the data set.
```{r "Remove Injuties and Property Costs = 0"}
# Create a new data.frame called "eventeffect" with Property_Damage_Cost or Injuries greater 0
tmp <- merge( propdmgevt, injbyevt, all=TRUE)
eventeffect <- tmp[ 
    tmp$Property_Damage_Cost>0 & 
    tmp$Injuries>0,]
```

In the other hand, when the total property cost is seen as cost per incident the
data shows interesting information. The following table shows that information 
decreasingly sorted by cost per incident(Cost_Per_Incident column):
```{r "Cost per Incident"}
eventeffect$Cost_Per_Incident <- eventeffect$Property_Damage_Cost/eventeffect$Injuries

print( 
    head(eventeffect
            [order(eventeffect$Cost_Per_Incident, decreasing=TRUE),]),
    row.names=FALSE)
```

River flood event is the most costly incident, even more that Tornado. A single
river flood incident is about 197 times as costly as a Tornado incident: 
```{r "Most costly per incident"}
tornadovsrflood <- 
    eventeffect[eventeffect$EVTYPE %in% c("TORNADO", "RIVER FLOOD"), ]

tornadovsrflood$proportion <- 
    tornadovsrflood$Cost_Per_Incident / 
            tornadovsrflood$Cost_Per_Incident[tornadovsrflood$EVTYPE=="TORNADO"]

print( tornadovsrflood, row.names=FALSE )
```


## Results
Tornado is the event with the most number of injuries and also with the higher
degree of property damages.

```{r "Pie Chart"}
newlabels <- rep("", times=length(eventeffect$EVTYPE))
attach(eventeffect)
# Appending the actual Cost_Per_Incident of Injuries to the labels
for( incident in c("TORNADO", "RIVER FLOOD", "COASTAL FLOOD") )
{
    newlabels[EVTYPE==incident ] <- 
    paste(incident, 
          round( Injuries[EVTYPE==incident]) )
}
pie( Injuries, labels=newlabels, main="Injuries by Event Type" )

# Appending the actual Cost_Per_Incident of Injuries to the labels
for( incident in c("TORNADO", "RIVER FLOOD", "COASTAL FLOOD") )
{
    newlabels[EVTYPE==incident ] <- 
    paste(incident, 
          round( Cost_Per_Incident[EVTYPE==incident]) )
}

pie( Cost_Per_Incident, labels=newlabels, 
     main="Property Damage Cost per Incident by Event Type" )
```

For costs units, the author could not find in the data dictionary what is the 
unit used for the data in the processed file.

### Conclusion
Based on the obteined results Tornado is the event that causes the most damage
to the society. The data shows `r round( Injuries[EVTYPE=="TORNADO"])` injuries
caused by this event. In contrast River Flood has `r round( Injuries[EVTYPE=="RIVER FLOOD"])`
documented injuries. Nevertheless, River Flood is the most costly event since it is `r round(tornadovsrflood$proportion[1])` times as costly as a Tornado event. Following in cost is
COASTAL FLOOD.


`r date()`